define("page/user/cart",function(t,e,a){t("common");var i=t("tapdelete"),s=t("imglazyload"),n=t("dialog");window.baidu=t("baiduTemplate");var o=null,r=0,d={};$(function(){loadCartItem(),initFunction()}),window.loadCartItem=function(){baseJS.App.sendToApp("flushAlert",'{"text":"购物车数据更新中..","position":"bottom","time":"1000"}'),baseJS.util.doRequest("",server+"/cart/getCartItem.cf",{},function(t){$("#cart_list_content .cart_list").remove();var e=t.data;if(e.length>0){for(var a="",n=0;n<e.length;n++){var d=parseInt(e[n].deliveryPrice),l="邮费：￥";0===d?l="免邮":l+=toMoney(d),r+=parseInt(e[n].itemSize);var c='<div class="cart_list row_list"><div class="cart_list_title"><span>'+e[n].topicName+'</span><span class="fr grey">'+l+'</span></div><ul style="overflow:hidden;">',u="";$.each(e[n].cartItemList,function(t,e){var a='<li data_item_id=\'{0}\' data-online-status=\'{1}\' data-goods-stock=\'{2}\'><div class="sh_num_adjust_btn"><i class="sh_num_adjust_btn_minus"></i><i class="sh_num_adjust_btn_text" id="goodsNum">{3}</i><i class="sh_num_adjust_btn_plus"></i><input type="hidden" value="{4}" name="prodeuct_param_num" id="prodeuct_param_num" class="param_p_item_value" /></div><a href="javascript:void(0)" title="{5}"><i class="list_radio"></i><img _src="{6}"src='+defaultProImg+' alt="产品"/><div class="row_list_right"><div class="sh_car_product_name">{7}</div><span class="number">&times; <span class="number_in">{8}</span></span><div class="clear"></div><div class="price_area"><p class="attrValue grey"  data-goods-id="{11}" data-goods-price="{12}" data-item-id="{13}"><span>{9}</span><i class="down-arrow"></i></p><span class="discount_price">￥{10}</span></div></div></a><div class="operation">刪除</div>';e.attributeValue=""!=e.attributeValue?e.attributeValue:"单一规格",u+=baseJS.util.formatString(a,e.id,e.online,e.stock,e.quantity,e.quantity,e.goods,e.images,e.goods,e.quantity,e.attributeValue,toMoney(e.price),e.goodsId,e.price,e.id)}),c+=u,c+='</ul>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="footer_nav bg_white cart_list_footer">\t\t\t\t\t\t\t<div class="select_all">全选</div>\t\t\t\t\t\t\t\t\t\t<div class="foot_right">\t\t\t\t\t\t\t\t\t\t\t\t\t<p class="total_money">\t\t\t\t\t\t\t\t\t\t\t\t\t\t合计：￥<span class="total_money_num">00.00</span>\t\t\t\t\t</p>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<a class="red_button settle_btn disabled" href="javascript:void(0)">结算</a>\t\t\t<a class="sh_delete_button delete_btn" href="javascript:void(0)"></a>\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t </div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>',a+=c}$("#cart_list_content .cart_product_status_notice").after(a),s.update(".cart_list"),o=o||new i({id:"#cart_list_content",xPos:$(".operation").width(),dtap:0}).init()}else $("#empty_cart").show();changeSettleStatus(),productStatusNotice(),rightAppAction()})},window.aniRemoveItem=function(t,e,a){$(t).bind("webkitTransitionEnd",a).css($.extend({transition:"0.5s"},e))},window.deleteItem=function(t){var e={"z-index":0,"margin-bottom":$(t).outerHeight()*-1,"margin-top":0};aniRemoveItem(t,e,function(){$(this).remove(),changeSettleStatus(),productStatusNotice()}),$(t).animate(e,600,function(){$(t).trigger("webkitTransitionEnd")})},$("#cart_list_content").delegate(".operation","click",function(){if(confirm("确认删除？")){var t=$(this).parent("li").attr("data_item_id"),e=$(this).parent("li");baseJS.util.doRequest("",server+"/cart/deleteCartItem.cf",{itemId:t},function(t){"true"===t.data||t.data===!0?(deleteItem(e),r--):alert("删除失败！")})}return!1}),window.removeCartItem=function(){$(".cart_list li.selected").each(function(){var t=$(this).attr("data_item_id"),e=this;baseJS.util.doRequest("",server+"/cart/deleteCartItem.cf",{itemId:t},function(t){"true"===t.data||t.data===!0?(deleteItem(e),r--):alert("删除失败！")})})},window.changeSettleStatus=function(t){if(t=t||$(".cart_list"),0===$("#cart_list_content").find("li[data_item_id]").size()){var e={"z-index":0,"margin-bottom":$("#cart_list_content").outerHeight()*-1,"margin-top":0};return aniRemoveItem($("#cart_list_content"),e,function(){$("#cart_list_content").remove(),$("#empty_cart").show(),rightAppAction(),$(this).remove()}),void $("#cart_list_content").trigger("webkitTransitionEnd")}$("#empty_cart").hide(),$.each(t,function(){var t=$(this).find("li"),e=t.not('[data-online-status="0"],[data-goods-stock="0"]'),a=e.size(),i=e.filter(".selected").size();if(0===t.size()){var s=$(this),n={"z-index":0,"margin-bottom":s.outerHeight()*-1,"margin-top":0};return aniRemoveItem(s,n,function(){$(this).remove()}),!0}if(0===a){var s=$(this).find(".footer_nav"),n={"z-index":0,"margin-bottom":s.outerHeight()*-1,"margin-top":0};return aniRemoveItem(s,n,function(){$(this).hide(),$(this).find(".select_all").addClass("selected")}),!0}0===i?($(this).find(".select_all").removeClass("selected"),$(this).find(".settle_btn,.delete_btn").addClass("disabled")):$(this).find(".settle_btn,.delete_btn").removeClass("disabled"),i===a?$(this).find(".select_all").addClass("selected"):$(this).find(".select_all").removeClass("selected");var o=0,r=e.filter(".selected");$.each(r,function(){var t=/^[^\d]/,e=$(this).find(".discount_price").size()>0?$(this).find(".discount_price").text():$(this).find(".old_price").text();e=e.replace(t,"");var a=$(this).find(".number").size()>0?$(this).find(".number").text():1;a=a.replace(t,""),o+=e*a}),$(this).find(".total_money_num").text(toMoney(o))}),$(".cart_list .select_all").size()===$(".cart_list .select_all.selected").size()?$(".select_all:last").addClass("selected"):$(".select_all:last").removeClass("selected")},window.productStatusNotice=function(){var t=$(".cart_product_status_notice");$('li[data-online-status="0"],li[data-goods-stock="0"]').size()>0?($('li[data-online-status="0"],li[data-goods-stock="0"]').addClass("disabled"),t.show()):t.hide()},window.initFunction=function(){$("#cart_list_content").on("click",".select_all",function(){var t=$(this),e=$(this).parents(".cart_list");0==e.size()&&(e=$(".cart_list")),t.hasClass("selected")?(t.removeClass("selected"),e.find("li").removeClass("selected")):(t.addClass("selected"),e.find("li").not('[data-online-status="0"],[data-goods-stock="0"]').addClass("selected")),changeSettleStatus(e)}),$("#cart_list_content").on("click","li[data_item_id]",function(t){t.stopPropagation();var e=$(this);if(!(0==e.data("online-status")||e.data("goods-stock")<=0)){e.toggleClass("selected");var a=e.parents(".cart_list");changeSettleStatus(a)}}),$("#cart_list_content").on("click",".delete_btn",function(){return 0===$(".cart_list li.selected").size()?void baseJS.App.sendToApp("flushAlert",'{"text":"请选择要删除的商品","position":"middle","time":"1000"}'):void(confirm("确认删除？")&&removeCartItem())}),$("#cart_list_content").on("click",".settle_btn",function(){if($(this).hasClass("disabled"))return!1;if(!confirm("确认结算？"))return!1;var t=$(this).parents("div.cart_list"),e=getCartItemId(t),a=decodeURI(e);baseJS.util.doRequest("",server+"/order/judgeStockEnoughOrNot.cf",{ids:e},function(t){"success"==t.status?newtab("/app/user/order/confirm/cart.html?ids="+a):baseJS.App.sendToApp("flushAlert",'{"text":"'+t.message+'","position":"middle","time":"1000"}')})}),$("#cart_list_content").on("click",".sh_num_adjust_btn_plus, .sh_num_adjust_btn_minus",function(t){t.stopPropagation();var e=$(this).parents("li"),a=e.data("goods-stock"),i=parseInt(e.find(".sh_num_adjust_btn_text").text());$(this).hasClass("sh_num_adjust_btn_plus")?i++:i--,i<1&&(i=1),i>a&&(i=a,baseJS.App.sendToApp("flushAlert",'{"text":"该宝贝库存不足啦","position":"middle","time":"1000"}')),$(this).siblings(".sh_num_adjust_btn_text").text(i),$(this).parents("li").find(".number_in").text(i)})},window.getCartItemId=function(t){var e=$(t[0]).find("li").filter(".selected"),a="";return $.each(e,function(t){var e=$(this).attr("data_item_id");a+=0===t?""+e:","+e}),a};var l=!0;window.edit=function(){return l?(baseJS.App.initPage("我的购物车",0,"",2,"完成",1,0,"editCallBack"),rightBtnCallEnableEdit()):(baseJS.App.initPage("我的购物车",0,"",2,"编辑",1,0,"editCallBack"),rightBtnCallDisableEdit()),l=!l,!1},window.rightBtnCallEnableEdit=function(){$(".sh_num_adjust_btn, .sh_delete_button").css("display","inline-block"),$('li[data-online-status="0"],li[data-goods-stock="0"]').find(".sh_num_adjust_btn, .sh_delete_button").hide(),$(".sh_car_product_name").hide(),$(".number").hide(),$(".footer_nav_opt").show(),$(".cart_list_footer").css({visibility:"hidden"}),$(".attrValue i").css({visibility:"visible"});var t="ontouchstart"in document.documentElement?"touchstart":"click";$("li:not('.disabled') .price_area").on("click",function(e){e.stopPropagation();var a=$(".attrValue",this),i=a.data("goods-id");baseJS.util.doRequest("",server+"/goods/goodsMessagesById.cf",{id:i},function(e){function i(t){var e=typeof t;if("string"==e)return t.length;if("object"==e){var a=0;for(var i in t)a++;return a}return!1}function s(){for(var t in u){var e=0,a=u[t].groupInfo;for(var i in p)_[p[i]]==a[p[i]]&&e++;if(e==v)return t}return!1}function o(t,e){var a=!0;for(var i in t)if(t[i]!=e[i]){a=!1;break}return a}function r(t){var e=$("#product_param_dialog").find(".attribute_content").size();$(".param_p_items .hover").size()==e&&$("#p_goodsNum").text("1");var a=parseInt($("#p_goodsNum").text());$("#quantity").val(a),$("#product_total_num").text(t.stock),$("#gavIds").val(t.gavId),$(".p_total_money").text("￥"+toMoney(t.salesPrice*a)),$("#orderform [name='price']").val(t.salesPrice),$("#orderform [name='totalPrice']").val($(".p_total_money").text()),"undefined"!=t.groupInfo&&(d.attributeValue=t.groupInfo,d.quantity=parseInt($("#p_goodsNum").text()))}function l(t,e){var a=$(".attribute_content").length,i=$(".attribute_content li.hover").length;if($("#confirmButton").attr("disabled",!0).addClass("disabled"),!(a>i+1)){e=e||{};var s=$(".attribute_content");a===i+1?s=s.not($("li.hover").parents(".attribute_content")):0!=parseInt($("#product_total_num").text())&&$("#confirmButton").attr("disabled",!1).removeClass("disabled"),s.each(function(){var a=$.extend({},e),i=$(this).find("li"),s=$(this).data("title");i.each(function(){var e=!1;a[s]=$(this).text();for(var i in t)if(o(a,t[i].groupInfo)&&t[i].stock>0){e=!0;break}e?$(this).removeClass("disabled"):$(this).addClass("disabled")})})}}if("success"!=e.status)return alert(e.message?e.message:e.status),baseJS.App.sendToApp("close",'{"callback":"console.log"}'),!1;var c=e.data.goodsMessagesDTO,u=c.attributesMessageMap.attributeGroupList;$("#product_param_dialog").html(baidu.template("_product_param_dialog",e.data)),l(u),$(".param_p_items").on(t,"li",function(){if(!$(this).hasClass("disabled")){$(this).hasClass("hover")?$(this).removeClass("hover"):$(this).addClass("hover").siblings("li.hover").removeClass("hover");var t={gavId:"",stock:c.stock,salesPrice:c.salesPrice},e={};if($(".attribute_content").each(function(){var t=$(this).find("li.hover");t.length>0?e[$(this).data("title")]=t.text():$(this).find("li.disabled").removeClass("disabled")}),$(".attribute_content").length===$(".attribute_content li.hover").length){t.stock=0;for(var a in u)if(o(e,u[a].groupInfo)){t=u[a];break}}return l(u,e),r(t),!1}});var _={},p=[],m=a.children("span").text().split(",");if($("#p_goodsNum").text(a.parents("li").find(".sh_num_adjust_btn_text").text()),"单一规格"!=a.children("span").text()){if(1==c.standard){$("#p_goodsNum").text(1),0==c.stock&&$("#p_goodsNum").text(0),$("#orderform [name='totalPrice']").val(toMoney(c.salesPrice*parseInt($("#p_goodsNum").text()))),$(".p_total_money").text("￥"+$("#orderform [name='totalPrice']").val());for(var f in m){var h=m[f].split(":");_[h[0]]=h[1],p.push(h[0])}var v=i(_),b=i(u[0].groupInfo);if(v==b&&s()!==!1){var g=u[parseInt(s())];0!=g.stock?($(".attribute_content").each(function(){var e=$(this),a=e.data("title");e.find("li").each(function(){$(this).text()==_[a]&&$(this).trigger(t)})}),$("#orderform [name='price']").val(toMoney(g.salesPrice)),$("#p_goodsNum").text(a.parents("li").find(".sh_num_adjust_btn_text").text()),0==g.stock&&$("#p_goodsNum").text(0),a.parents("li").find(".sh_num_adjust_btn_text").text()>g.stock&&$("#p_goodsNum").text(g.stock),$("#product_total_num").text(g.stock),$("#orderform [name='totalPrice']").val(toMoney(g.salesPrice*parseInt($("#p_goodsNum").text()))),$(".p_total_money").text("￥"+$("#orderform [name='totalPrice']").val())):($("#orderform [name='price']").val(toMoney(c.salesPrice)),$("#p_goodsNum").text(1),0==c.stock&&$("#p_goodsNum").text(0),$("#product_total_num").text(c.stock),$("#orderform [name='totalPrice']").val(toMoney(c.salesPrice*parseInt($("#p_goodsNum").text()))),$(".p_total_money").text("￥"+$("#orderform [name='totalPrice']").val()))}}0==c.standard&&($("#p_goodsNum").text(1),0==c.stock&&($("#p_goodsNum").text(0),$("#confirmButton").attr("disabled",!0).addClass("disabled")))}else 0==c.standard?($("#p_goodsNum").text(a.parents("li").find(".sh_num_adjust_btn_text").text()),c.stock<parseInt(a.parents("li").find(".sh_num_adjust_btn_text").text())&&$("#p_goodsNum").text(c.stock),$(".p_total_money").text("￥"+$("#orderform [name='totalPrice']").val())):$("#p_goodsNum").text(1),0==c.stock&&($("#p_goodsNum").text(0),$("#confirmButton").attr("disabled",!0).addClass("disabled")),$("#orderform [name='totalPrice']").val(toMoney(c.salesPrice*parseInt($("#p_goodsNum").text()))),$(".p_total_money").text("￥"+$("#orderform [name='totalPrice']").val());d={cartId:a.data("item-id"),quantity:parseInt($("#p_goodsNum").text()),attributeValue:_};var x=new n({id:"#product_param_dialog",position:"bottom",close_btn:".close_btn",ani_show:!0,cover_hide:!0});x.show(),$(".param_p_items").on("touchmove","li",function(t){if("originalEvent"in t)return t=t.originalEvent,t.stopPropagation(),t.preventDefault(),!1}),window.numAjust=function(t){var e=parseInt($("#p_goodsNum").text()),a=parseInt($("#product_total_num").text()),i=$("#orderform [name='price']").val();i=i.replace(/^[^\d]/,"");var s=t+e;s>a||s<1||($(".num_adjust_btn_text").text(s),$("#quantity").val(s),$(".p_total_money").text("￥"+toMoney(s*i)),$("#orderform [name='totalPrice']").val(toMoney(s*i)),d.quantity=parseInt($("#p_goodsNum").text()))},$("#confirmButton").off("click"),$("#confirmButton").on("click",function(t){if(t.preventDefault(),parseInt($("#p_goodsNum").text())>parseInt($("#product_total_num").text()))return baseJS.App.sendToApp("flushAlert",'{"text":"库存不足，保存失败!","position":"bottom","time":"2000"}'),!1;var e="";0!=i(d.attributeValue)?($.each(d.attributeValue,function(t,a){e+=t+":"+a+","}),e=e.substring(0,e.length-1),a.attr("data-attr-value",e),a.children("span").text(e)):(a.attr("data-attr-value","单一规格"),a.children("span").text("单一规格")),a.parents("li").data("goods-stock",$("#product_total_num").text()),a.parents("li").find(".sh_num_adjust_btn_text").text(d.quantity),a.parents("li").find(".number_in").text(d.quantity),a.parents("li").find(".discount_price").text("￥"+toMoney($("[name='price']").val())),x.hide()})})})},window.rightBtnCallDisableEdit=function(){$("#product_param_dialog").hide(),$("#cover").hide(),$(".footer_nav_opt").hide(),$(".sh_num_adjust_btn, .sh_delete_button").hide(),$("li:not('.disabled') .price_area").off("click"),$(".sh_car_product_name").show(),$(".number").show(),$(".attrValue i").css({visibility:"hidden"}),$(".cart_list_footer").css({visibility:"visible"});var t=$(".cart_list li"),e=new Array;$.each(t,function(){var t={};t.cartItemId=$(this).attr("data_item_id"),t.attributeValue=$(".attrValue",this).find("span").text(),void 0!=$(".attrValue",this).attr("data-attr-value")&&(t.attributeValue=$(".attrValue",this).attr("data-attr-value")),"单一规格"==t.attributeValue&&(t.attributeValue=""),t.quantity=$(this).find(".sh_num_adjust_btn_text").text(),e.push(t)});var a=JSON.stringify(e);$.ajax({type:"POST",url:server+"/cart/updateCarGoodsQuantity.cf",data:a,async:!1,dataType:"json",contentType:"application/json",cache:!1,success:function(t){"success"==t.status?baseJS.App.sendToApp("flushAlert",'{"text":"保存成功!","position":"bottom","time":"2000"}'):(baseJS.App.sendToApp("flushAlert",'{"text":"保存失败!","position":"bottom","time":"2000"}'),setTimeout(function(){location.reload()},2e3))}}),changeSettleStatus()},window.rightAppAction=function(){r>0?baseJS.App.initPage("我的购物车",0,"",2,"编辑",1,0,"editCallBack"):baseJS.App.initPage("我的购物车",0,"",0,"",1,0,"")},window.editCallBack=function(){edit()},window.orderOverCallback=function(){window.location.href="/app/user/order.html"},window.closeAutoCallback=function(){localStorage.getItem("needUpdateCart")&&(localStorage.setItem("needUpdateCart",""),s.update(".cart_list"),r=0,loadCartItem())}});