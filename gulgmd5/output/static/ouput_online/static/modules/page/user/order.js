define("page/user/order",function(e){e("common"),e("plugins/md5");var a=e("loadmore"),t=e("dialog"),r=e("DateUtil");$(function(){baseJS.App.initPage("我的订单",0,"",0,"",1,0,""),init()}),window.payPasswordSet=null;var o,n={},i={},s=0;window.init=function(){n=new t({id:"#not_set_paycode",position:"middle",close_btn:".paycode_close_btn",close_callback:function(){$(".payment").hasClass("disabled")&&$(".payment").removeClass("disabled")}}),$("#choosePayWay").on("change","input",function(){return $(this).attr("readonly")?!1:void checkedCallback()}),tabNav(),l(),loadMoreData2(),bindBtn(),"gopay"==location.hash.substr(1)&&$(".nav li:eq(1)").click()},window.deleteCallBack=function(){},window.paySuccessCallback=function(){window.location.reload(!0)},window.myOrder=function(){baseJS.util.doRequest("",server+"/order/dealOrderNum.cf",{},function(e){""!==e.data.paymentOrderNum&&(parseInt(e.data.paymentOrderNum)>0?($("#payment").html(e.data.paymentOrderNum),$("#payment").addClass("new_notice")):($("#payment").html(""),$("#payment").removeClass("new_notice"))),""!==e.data.confirmOrderNum&&(parseInt(e.data.confirmOrderNum)>0?($("#confirmReceipt").html(e.data.confirmOrderNum),$("#confirmReceipt").addClass("new_notice")):($("#confirmReceipt").html(""),$("#confirmReceipt").removeClass("new_notice")))})},window.loadOrders=function(e){myOrder();var a="";return $.each(e,function(e,t){var o=t[0],n=t[1],i=t[1].length,s="<li data_order_id='{0}'><div class='order_title'><p><span class='order_status {1}'>{2}</span><input class='orderId' type='hidden' value='{3}' /><input class='topicId' type='hidden' value='{4}' />订单号:<span class='orderNum'>{5}</span><br />下单时间：{6} </p></div>",d="<a target='_blank' href='/app/user/order/orderItemPage.html?orderId="+o.id+"'>",l="";n.length>0&&(n.length>1?($.each(n,function(e,a){3>e&&(l+=baseJS.util.formatString("<img class='multi_product_img' src='{0}' />",a.url))}),s+=d+l+"</a>"):(d+="<img src='{0}' /><div class='row_list_right'><div class='product_name'>{1}</div></div></a>",s+=baseJS.util.formatString(d,n[0].url,n[0].goodsName))),s+="<div class='order_result'><p>共{7}件商品，实付：<span class='red'>￥<span class='totalMoney'>{8}</span></span>{9}</p></div></li>";var c=btnStatus(o),u=c.statusColor,p=c.statusText,f=buildBtn(c.btnStatus);a+=baseJS.util.formatString(s,o.id,u,p,o.id,o.topicId,o.orderNum,r.dateToStr("yyyy-MM-dd HH:mm:ss",new Date(o.orderTime)),i,toMoney(parseFloat(o.goodsPrice)+parseFloat(o.deliveryPrice)),f)}),a},window.btnStatus=function(e){var a="yellow",t=" ",r=0;switch(e.tradeStatus){case-1:case 3:a="grey",t="订单取消",r=-1;break;case 0:"0"==e.receiptStatus&&"1"==e.deliveryStatus?(t="已发货",r=3):"0"==e.paymentStatus?(t="待付款",r=1):"0"==e.deliveryStatus?(t="待发货",r=2):(t="交易完成",r=4);break;case 1:a="green",t="交易完成",r=4}return{statusColor:a,statusText:t,btnStatus:r}},window.buildBtn=function(e){var a="<a href='javascript:void(0);' class='{0} button'>{1}</a>",t="",r="";switch(e){case-1:t="delete_order grey_button",r="删除订单";break;case 1:t="payment red_button",r="去支付";break;case 2:break;case 3:t="confirmReceipt red_button",r="确认收货";break;case 4:t="delete_order grey_button",r="删除订单"}return baseJS.util.formatString(a,t,r)},window.btnApplicationStatus=function(e){var a="yellow",t=" ",r=0;switch(e.status){case 0:a="green",t="审核中",r=0;break;case 1:a="green",t="系统已拒绝",r=1;break;case 2:a="green",t="寄还商品",r=2;break;case 3:a="green",t="处理中",r=3;break;case 4:a="grey",t="已退货",r=4;break;case 5:a="grey",t="已退款",r=4}return{statusColor:a,statusText:t,btnStatus:r}},window.btnApplication=function(e,a){var t="<a target='_blank' href='/app/user/order/returnGoodsProgress.html?id="+a+"' class='{0} button'>{1}</a>",r="",o="";switch(e){case 0:r="red_button",o="查看进度";break;case 1:r="red_button",o="查看详情";break;case 2:r="red_button",o="寄还商品";break;case 3:r="red_button",o="查看进度";break;case 4:r="red_button",o="查看详情"}return baseJS.util.formatString(t,r,o)};var d=new Array,l=function(){d[0]=new a({id:"all_order",initUrl:server+"/order/orders.cf?orderType=1&pageNo={pageValue}",queryCallback:orders}).init(),d[1]=new a({id:"wait_buyer_pay_order",initUrl:server+"/order/orders.cf?orderType=2&pageNo={pageValue}",queryCallback:orders}).init(),d[2]=new a({id:"wait_buyer_confirm_goods_order",initUrl:server+"/order/orders.cf?orderType=3&pageNo={pageValue}",queryCallback:orders}).init()};window.loadMoreData2=function(){d[3]=new a({id:"wait_buyer_return_goods",initUrl:server+"/returngoods/getReturnGoods.cf?pageNo={pageValue}",queryCallback:returnGoods}).init();for(var e in d)e!=$(".nav li.hover").index()?d[e].temploadlock=!0:(d[e].temploadlock=!1,d[e].checkStatus())},window.returnGoods=function(e){var a="";return $.each(e,function(e,t){var o="<li data_return_application_id='{0}'><div class='order_title'><p><span class='order_status {1}'>{2}</span><input class='orderId' type='hidden' value='{3}' />退货单号:<span class='orderNum'>{4}</span><br />申请时间：{5} </p></div>",n="<a href='javascript:void(0);' class='no_arrow' >",i="";i+="<img src='{6}' />",o+=n+i+"<div class='row_list_right'><div class='product_name'>"+t.goodName+"</div></div></a>",o+="<div class='order_result'><p>共{7}件商品，实付：<span class='red'>￥<span class='totalMoney'>{8}</span></span>{9}</p></div></li>";var s=btnApplicationStatus(t),d=s.statusColor,l=s.statusText,c=btnApplication(s.btnStatus,t.id);a+=baseJS.util.formatString(o,t.id,d,l,t.returnNum,t.returnNum,r.dateToStr("yyyy-MM-dd HH:mm:ss",new Date(t.createTime)),t.url,"1",toMoney(t.totalPrice),c)}),a},window.orders=function(e){return loadOrders(e)},window.tabNav=function(){function e(e){var a=$(".nav li.hover").index();if(a!==e){$(".nav li:eq("+e+")").addClass("hover").siblings().removeClass("hover"),$(".order_list ul:eq("+e+")").css("height","auto").siblings().css("height",$(window).height()-$(".nav").outerHeight()),$(".order_list").css({transform:"translateX("+$(".order_list ul:eq(0)").outerWidth()*e*-1+"px)"});for(var t in d)t!=$(".nav li.hover").index()?d[t].temploadlock=!0:(d[t].temploadlock=!1,d[t].checkStatus())}}$(".nav").delegate("li","click",function(){e($(this).index())})},window.bindBtn=function(){$(".order_list").delegate(".delete_order","click",function(){if(confirm("是否删除订单？")){var e=$(this).parents("li").attr("data_order_id");baseJS.util.doRequest("",server+"/order/deleteOrder.cf",{orderId:e},function(e){"true"==e.data||1==e.data?window.location.reload():alert("删除订单失败！")})}return!1}),$(".order_list").delegate(".confirmReceipt","click",function(){if(confirm("是否确认收货？")){var e=$(this).parents("li").attr("data_order_id");baseJS.util.doRequest("",server+"/order/confirmReceiptAll.cf",{orderId:e},function(e){"true"==e.data||1==e.data?window.location.reload():alert("确认收货失败！")})}return!1})};var c,u=0,p=0,f=0,m=0,s=0;$(function(){c=new t({id:"#confirm_action_dialog",position:"middle",close_btn:"#confirm_action_dialog_cancle_btn",close_callback:function(){$(".payment").hasClass("disabled")&&$(".payment").removeClass("disabled")}}),$("#confirm_action_dialog button.enogh").click(function(){if(!$(this).hasClass("disabled")){var e=$("#payPassword").val();if(""==e)return baseJS.App.sendToApp("flushAlert",'{"text":"请输入支付密码","position":"bottom","time":"3000"}'),!1;var a=/^\d{6}$/i;if(!$.trim(e).match(a))return baseJS.App.sendToApp("flushAlert",'{"text":"支付密码格式不正确","position":"bottom","time":"3000"}'),!1;var t=$("#choosePayWay").find("input:checked");if(0==t.size())return baseJS.App.sendToApp("flushAlert",'{"text":"请选择兑换方式","position":"bottom","time":"3000"}'),!1;$(this).text("支付处理中..").addClass("disabled"),o=$(this);var r=[];$.each(t,function(e,a){r.push(a.value)});var n=[];n.push("orderId="),n.push(m),n.push("&"),n.push("payPassword="),n.push(hex_md5(e)),n.push("&topicIdArrayStr="),n.push(r.toString()),baseJS.App.sendToApp("encrypt",'{"data":"'+n.join("")+'","callback":"aesEncryptJS"}')}}),$("#confirm_action_dialog button.notenogh").click(function(){isNewVersion()?baseJS.App.sendToApp("toRecharge",'{"callback": "recharge"}',""):baseJS.App.sendToApp("recharge",'{"callback": "recharge"}',"")}),$(".order_list").delegate(".payment","click",function(){return $(this).hasClass("disabled")?void 0:($(this).addClass("disabled"),i=$(this),u=$(this).parents("li").find(".orderNum").html(),p=$(this).parents("li").find(".totalMoney").html(),m=$(this).parents("li").find("input.orderId").val(),s=$(this).parents("li").find("input.topicId").val(),f=0,$("#order_Num").text(u),$("#real_price").text(p),confirmAction(m,p,s),!1)})}),window.checkedCallback=function(){var e=$("#choosePayWay").find("input:checked"),a=0;$.each(e,function(e,t){var r=t.dataset.availableMoney;a+=parseFloat(r)}),a>=p?$("#confirm_action_dialog button.enogh").text("确认兑换").removeClass("disabled"):$("#confirm_action_dialog button.enogh").text("确认兑换").addClass("disabled")},window.confirmAction=function(e,a,t){baseJS.util.doRequest("",server+"/wallet/availableWallet.cf",{topicId:t,payMoney:a},function(e){if(!passwordSetStatus())return n.show(),!1;for(var t=e.data,r=[],o=0,i=0;i<t.length;i++){o+=parseFloat(t[i].availableMoney);var s=t[i].checked?' checked="checked" readOnly disabled="disabled" onclick="return false;"  ':"";r+='<label class="pay_cards_item" ><input type="checkbox" value='+t[i].topicId+s+" data-available-money="+t[i].availableMoney+" />"+t[i].industryCardName+" 余额：￥"+t[i].availableMoney+"</label>"}$("#choosePayWay").html(r),$("#payPassword").val("");var d=$("#confirm_action_dialog");d.hasClass("rechargeOnline")&&(d.removeClass("rechargeOnline"),$("#confirm_action_dialog_notice").text("余额不足，请先充值"),d.find(".button.notenogh").text("去充值")),parseFloat(a)<=parseFloat(o)?($("#confirm_action_dialog .enogh").show(),$("#confirm_action_dialog .notenogh").hide(),checkedCallback()):($("#confirm_action_dialog .enogh").hide(),$("#confirm_action_dialog .notenogh").show(),isNewVersion()&&($("#confirm_action_dialog").addClass("rechargeOnline"),$(".diffMoney").text(toMoney(parseFloat(a)-parseFloat(o))),$("#confirm_action_dialog_notice").text("限时专享 不容错过"),$("#confirm_action_dialog").find(".button.notenogh").text("马上去充值"))),c.show()},!1)},window.isNewVersion=function(){if(baseJS.App.getAppInfo(),window.appInfo){var e="object"==typeof window.appInfo?window.appInfo:$.parseJSON(window.appInfo),a=e.version.split(".");if("扫码购"==e.name&&a[0]>=2&&a[1]>=0)return 1}return 0},window.getAppInfo=function(e){window.appInfo=e},window.passwordSetCallback=function(){payPasswordSet=!0,i.removeClass("disabled"),n.hide(),passwordSetStatus(!0)},window.aesEncryptJS=function(e){baseJS.util.doRequest("",server+"/order/payment.cf",{auth:e},function(e){var a=e.data.resultInfo;if("paid_success"==a)newtab("/app/user/order/paymentResult.html?success=true");else{if("password_incorrect"==a)return o.text("确认兑换").removeClass("disabled"),baseJS.App.sendToApp("flushAlert",'{"text":"支付密码不正确！","position":"bottom","time":"3000"}'),!1;var t=e.data.resultMessage;newtab("/app/user/order/paymentResult.html?success=false&resultMessage="+t)}})},window.passwordSetStatus=function(e){return e||null===payPasswordSet?(baseJS.util.doRequest("",server+"/paypassword/checkHavePayPassword.cf",{},function(e){payPasswordSet=e.data?!0:!1},!1),payPasswordSet):payPasswordSet},window.recharge=function(){confirmAction(m,p,s)},window.onresume=function(){window.location.reload()},window.orderOverCallback=function(){onresume()},window.closeAutoCallback=function(){var e=localStorage.getItem("reloadReturnList");"true"==e&&($("#wait_buyer_return_goods li:not(.load_more)").remove(),loadMoreData2(),localStorage.removeItem("reloadReturnList"))}});